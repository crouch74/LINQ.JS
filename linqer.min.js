!function(a,b){"function"==typeof define&&define.amd?define([],b):"object"==typeof exports?module.exports=b():a.LINQ=b()}(this,function(){function LINQ(a){if(!(a&&a instanceof Array))throw new Error("You need to provide an array");return this._list=a,this._queriesQueue=[],this._getArray=_getArray,this._setArray=_setArray,this._enqueueExpression=_enqueueExpression,this._evaluateExpressions=_evaluateExpressions,this._eWhere=eWhere,this._eSelect=eSelect,this._eSkip=eSkip,this._eTake=eTake,this._eSkipTake=eSkipTake,this._eReverse=eReverse,this._eRemoveAll=eRemoveAll,this._eGroupBy=eGroupBy,this._eOrderBy=eOrderBy,this._eDistinct=eDistinct,this._eIntersect=eIntersect,this._eJoin=eJoin,this._eSelectMany=eSelectMany,this.toArray=toArray,this.toDictionary=toDictionary,this.where=where,this.select=select,this.count=count,this.any=any,this.all=all,this.sum=sum,this.average=average,this.skip=skip,this.take=take,this.max=max,this.min=min,this.reverse=reverse,this.removeAll=removeAll,this.single=single,this.singleOrDefault=singleOrDefault,this.first=first,this.firstOrDefault=firstOrDefault,this.last=last,this.lastOrDefault=lastOrDefault,this.groupBy=groupBy,this.orderBy=orderBy,this.orderByDescending=orderByDescending,this.distinct=distinct,this.intersect=intersect,this.join=join,this.selectMany=selectMany,this}function _getArray(){return this._list}function _setArray(a){this._list=a}function toArray(){return this._evaluateExpressions(),Array.isArray(this._list)||(this._list=dictionaryToArray(this._list)),this._list}function toDictionary(a,b){if(this._evaluateExpressions(),Array.isArray(this._list)){if(!a&&!b)throw new Exception("An array can't be converted to a dictionary without mapping functions");a=parse(a),b=parse(b),this._list=arrayToDictionary(this._list,a,b)}else(a||b)&&(a=parse(a||"x=>x"),b=parse(b||"x=>x"),this._list=mapDictionary(this._list,a,b));return this._list}function where(a){return this._enqueueExpression("where",a),this}function groupBy(a,b){return this._enqueueExpression("groupBy",[a,b||"x=>x"]),this}function skip(a){return checkIfNumber(a,"Skip"),this._enqueueExpression("skip",a),this}function take(a){return checkIfNumber(a,"Take"),this._enqueueExpression("take",a),this}function select(a){return this._enqueueExpression("select",a),this}function reverse(){return this._enqueueExpression("reverse"),this}function removeAll(a){return this._enqueueExpression("removeAll",a),this}function orderBy(a){return this._enqueueExpression("orderBy",a),this}function orderByDescending(a){return this.orderBy(a).reverse(),this}function distinct(){return this._enqueueExpression("distinct"),this}function join(a,b,c,d){return this._enqueueExpression("join",[a,b,c,d]),this}function intersect(a){return this.distinct(),this._enqueueExpression("intersect",a),this}function selectMany(a,b){return this._enqueueExpression("selectMany",[a,b]),this}function count(a){return checkIflist(this._getArray(),"Count"),a&&this.where(a),this.toArray().length}function max(a){return checkIflist(this._getArray(),"Max"),a&&this.select(a),Math.max.apply(null,this.toArray())}function min(a){return checkIflist(this._getArray(),"Min"),a&&this.select(a),Math.min.apply(null,this.toArray())}function any(a){return checkIflist(this._getArray(),"Any"),this.toArray().some(parse(a))}function all(a){return checkIflist(this._getArray(),"All"),this.toArray().every(parse(a))}function sum(a){return checkIflist(this._getArray(),"Sum"),a&&this.select(a),this.toArray().reduce(function(a,b){return a+b},0)}function average(a){checkIflist(this._getArray(),"Average"),a&&this.select(a);var b=this.toArray();return b.reduce(function(a,b){return a+b},0)/b.length}function single(a){checkIflist(this._getArray(),"Single"),a&&this.where(a);var b=this.toArray();if(b.length>1)throw new Error("Sequene contains "+b.length+" elements");if(0===b.length)throw new Error("Sequene doesn't contain any elements");return b[0]}function singleOrDefault(a){checkIflist(this._getArray(),"SingleOrDefault"),a&&this.where(a);var b=this.toArray();if(b.length>1)throw new Error("Sequene contains "+b.length+" elements");return 0===b.length?null:b[0]}function first(a){checkIflist(this._getArray(),"First"),a&&this.where(a);var b=this.toArray();if(0===b.length)throw new Error("Sequence doesn't contain any elements");return b[0]}function firstOrDefault(a){checkIflist(this._getArray(),"FirstOrDefault"),a&&this.where(a);var b=this.toArray();return 0===b.length?null:b[0]}function last(a){checkIflist(this._getArray(),"Last"),a&&this.where(a);var b=this.toArray();if(0===b.length)throw new Error("Sequence doesn't contain any elements");return b[b.length-1]}function lastOrDefault(a){checkIflist(this._getArray(),"LastOrDefault"),a&&this.where(a);var b=this.toArray();return 0===b.length?null:b[b.length-1]}function eWhere(a){checkIflist(this._getArray(),"Where"),this._setArray(this._getArray().filter(parse(a)))}function eSelect(a){checkIflist(this._getArray(),"Select"),this._setArray(this._getArray().map(parse(a)))}function eSkip(a){checkIflist(this._getArray(),"Skip"),this._setArray(this._getArray().slice(a))}function eTake(a){checkIflist(this._getArray(),"Take"),this._setArray(this._getArray().slice(0,a))}function eSkipTake(a){checkIflist(this._getArray(),"SkipTake"),this._setArray(this._getArray().slice(a[0],a[0]+a[1]))}function eReverse(){checkIflist(this._getArray(),"Reverse"),this._setArray(this._getArray().reverse())}function eRemoveAll(a){checkIflist(this._getArray(),"RemoveAll"),a=parse(a),this._setArray(this._getArray().filter(function(b){return!a(b)}))}function eGroupBy(a){checkIflist(this._getArray(),"GroupBy"),keyFn=parse(a[0]),valueFn=parse(a[1]),this._setArray(this._getArray().reduce(function(a,b){var c=keyFn(b),d=valueFn(b);return a[c]?a[c].push(d):a[c]=[d],a},{}))}function eOrderBy(a){checkIflist(this._getArray(),"OrderBy"),a=parse(a),this._setArray(this._getArray().sort(sortingFn(a)))}function eJoin(a){checkIflist(this._getArray(),"Join"),checkIflist(a[0],"Join"),arr=a[0],key1Fn=parse(a[1]),key2Fn=parse(a[2]),resultFn=parse(a[3]),this._setArray(this._getArray().reduce(function(a,b){var c=arr.filter(function(a){return isEqual(key1Fn(b),key2Fn(a))}),d=c.map(function(a){return resultFn(b,a)});return a=a.concat(d)},[]))}function eIntersect(a){return checkIflist(this._getArray(),"Intersect"),checkIflist(a,"Intersect"),0==a.length?void this._setArray([]):void this._setArray(this._getArray().reduce(function(b,c){return indexOf(a,c)>-1&&b.push(c),b},[]))}function eDistinct(){checkIflist(this._getArray(),"Distinct");var a=this._getArray();this._setArray(a.reduce(function(b,c,d){return indexOf(a,c)===d&&b.push(c),b},[]))}function eSelectMany(a){checkIflist(this._getArray(),"SelectMany");var b=parse(a[0]),c=a[1]?parse(a[1]):function(a,b){return b},d=this._getArray();d=d.map(function(a,d){var e=[a,b(a,d)];return e[1].map(function(a){return c(e[0],a)})});var e=d.reduce(function(a,b){return a=a.concat(b)},[]);this._setArray(e)}function indexOf(a,b){for(i in a)if("object"==typeof b?isEqual(a[i],b):a[i]==b)return parseInt(i);return-1}function isEqual(a,b){return a===b?!0:a==b?!0:typeof a!=typeof b?!1:"object"!=typeof a?a==b:Array.isArray(a)?Array.isArray(b)?a.length!==b.length?!1:a.every(function(a){return indexOf(b,a)>-1})&&b.every(function(b){return indexOf(a,b)>-1}):!1:(aProps=Object.keys(a),bProps=Object.keys(b),aProps.length!==bProps.length?!1:aProps.every(function(c){return"object"==typeof a[c]?isEqual(a[c],b[c]):isEqual(a[c],b[c])})&&bProps.every(function(c){return"object"==typeof b[c]?isEqual(b[c],a[c]):isEqual(b[c],a[c])}))}function sortingFn(a){return function(b,c){return b=a(b),c=a(c),c>b?-1:b>c?1:0}}function _enqueueExpression(a,b){var c=this._queriesQueue;if(c.length>=1){var d=c.length-1,e=c[d];"take"===a&&"skip"===e[0]&&(c[d]=["skipTake",[e[1],b]])}c.push([a,b])}function _evaluateExpressions(){for(;this._queriesQueue.length>0;){var a=this._queriesQueue.shift(),b=a[0],c=a[1];if(b=b.charAt(0).toUpperCase()+b.slice(1),b="_e"+b,!this[b])throw new Error("Unhandled query !");this[b](c)}}function parse(a){var b=/w*\s*=>\s*w*/;if("string"!=typeof a&&!a)throw new Error("Not a valid fuction or lambda expression");if(isFunction(a))return a;if("string"==typeof a&&b.test(a))return lambdaToFunction(a);throw new Error("Not a valid fuction or lambda expression")}function lambdaToFunction(expression){var tokens=expression.split("=>");if(tokens.length>2)throw new Error("LINQ.js doesn't support nested lambda yet!");return function(){var fn="temp = function("+tokens[0].trim()+"){return "+tokens[1].trim()+"}";return eval(fn)}()}function isFunction(a){return!!(a&&a.constructor&&a.call&&a.apply)}function checkIfNumber(a,b){if("number"!=typeof a)throw new Error(b+" expects a number !");return!0}function checkIflist(a,b){if(!Array.isArray(a))throw new Error(b+" expects an array !");return!0}function dictionaryToArray(a){return keys=Object.keys(a),keys.map(function(b){return[b,a[b]]})}function mapDictionary(a,b,c){return Object.keys(a).reduce(function(d,e){return d[b(e)]=c(a[e]),d},{})}function arrayToDictionary(a,b,c){return a.reduce(function(a,d){return a[b(d)]=c(d),a},{})}function ctor(a){return new LINQ(a)}return Array.prototype.toLINQ=function(){return new LINQ(this)},ctor});